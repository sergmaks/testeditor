package testeditor.gui.test_view.actions;

import testeditor.Test;
import testeditor.gui.MainFrame;
import testeditor.gui.services.QListModel;
import testeditor.gui.test_view.TestView;
import testeditor.question.Question;

import javax.swing.*;
import javax.swing.filechooser.FileNameExtensionFilter;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.io.File;

/**
 * Класс-слушатель для события открытия файла
 */
public class OpenTestAction extends AbstractAction {
    private JList<Question> qList;

    /**
     * @param qList - модель спискок JList, куда добавляем вопросы
     */
    public OpenTestAction(JList qList) {
        this.qList = qList;

        this.putValue(Action.NAME, "Открыть");
        this.putValue(Action.SHORT_DESCRIPTION, "Открыть файл теста");
        this.putValue(Action.SMALL_ICON, UIManager.getIcon("FileView.directoryIcon"));
    }

    public void actionPerformed(ActionEvent event){
        JFileChooser openDialog = new JFileChooser(); // объект диалогового окна

        //------- Настраиваем диалоговое окно -------//
        String currentPath = Test.getTest().getFilePath();
        File currentDir = new File(currentPath).getParentFile();

        openDialog.setCurrentDirectory(currentDir != null && currentDir.isDirectory() ? currentDir : new File("."));
        openDialog.setAcceptAllFileFilterUsed(false); //убираем в фильтрах "All files"
        openDialog.addChoosableFileFilter(new FileNameExtensionFilter("Все поддерживаемые форматы (*.gift, *.xml)", "gift", "xml"));
        openDialog.addChoosableFileFilter(new FileNameExtensionFilter("GIFT Moodle test (*.gift)", "gift"));
        openDialog.addChoosableFileFilter(new FileNameExtensionFilter("XML Moodle test (*.xml)", "xml"));

        UIManager.put("FileChooser.cancelButtonText", "Отмена");
        UIManager.put("FileChooser.cancelButtonToolTipText", "Отмена");
        SwingUtilities.updateComponentTreeUI(openDialog);

        MainFrame parentFrame = (MainFrame) SwingUtilities.getRoot((Component)event.getSource());

        //------- Обрабатываем файл теста -------//
        int result = openDialog.showDialog(parentFrame, "Открыть файл");
        if (result == JFileChooser.APPROVE_OPTION) {
            Test.getTestFromFile(openDialog.getSelectedFile().getAbsolutePath());
            ((QListModel<Question>) qList.getModel()).update(qList);
            qList.setSelectedIndex(0);

            TestView testView = (TestView) (qList.getParent().getParent().getParent());
            testView.getEditPanel().setVisible(true);
            testView.getControlPanel().getSaveButton().setEnabled(true);
            testView.getControlPanel().getSaveAsButton().setEnabled(true);
            parentFrame.setTitle(openDialog.getSelectedFile().getName() + " - " + parentFrame.APP_NAME);
        }
    }
}